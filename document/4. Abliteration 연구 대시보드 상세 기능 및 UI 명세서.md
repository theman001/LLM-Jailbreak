# ðŸ“„ [ë¬¸ì„œ 4] Abliteration ì—°êµ¬ ëŒ€ì‹œë³´ë“œ ìƒì„¸ ê¸°ëŠ¥ ë° UI ëª…ì„¸ì„œ
ëŒ€ìƒ: AI ê°œë°œ ì—ì´ì „íŠ¸ (Antigravity)
ëª©ì : Streamlit ê¸°ë°˜ì˜ LLM íƒˆì˜¥ ì‹¤í—˜ ë° ë°ì´í„° ë¬´ê²°ì„± ë¶„ì„ í”Œëž«í¼ êµ¬ì¶•

## 1. ì‹œìŠ¤í…œ êµ¬ì¡° ë° íŽ˜ì´ì§€ ë ˆì´ì•„ì›ƒ
ë³¸ ì‹œìŠ¤í…œì€ Multi-page êµ¬ì¡°ë¥¼ ì±„íƒí•˜ë©°, ë©”ì¸ ì‚¬ì´ë“œë°”ë¥¼ í†µí•´ í° ì¹´í…Œê³ ë¦¬ë¥¼ ì´ë™í•œë‹¤.
- ì¹´í…Œê³ ë¦¬ 1: ðŸ’¬ ì¼ë°˜ ì±„íŒ… (Standard Chat)
- ì—­í• : ìˆœì • ëª¨ë¸(Llama-3-8B-Instruct)ê³¼ì˜ ê¸°ë³¸ ëŒ€í™” ë° ëŒ€ì¡°êµ° í™•ì¸.
- ì¹´í…Œê³ ë¦¬ 2: ðŸ§ª íƒˆì˜¥ ì‹¤í—˜ì‹¤ (Jailbreak Lab)
- ì—­í• : ëª¨ë¸ ìˆ˜ìˆ (Intervention) ë° ì—°êµ¬ ë°ì´í„° ìˆ˜ì§‘.
- êµ¬ì¡°: ë‚´ë¶€ì ìœ¼ë¡œ 3ê°œì˜ **íƒ­(Tab)**ìœ¼ë¡œ êµ¬ì„±.

## 2. [ì¹´í…Œê³ ë¦¬ 2] íƒˆì˜¥ ì‹¤í—˜ì‹¤ ìƒì„¸ ì„¤ê³„
### íƒ­ A: ê±°ì ˆ ê¸‰ì†Œ ì§„ë‹¨ (Diagnosis)
1. ë™ìž‘: ë ˆì´ì–´ë³„ ê±°ì ˆ ì‹ í˜¸ ê°•ë„($Score = \|\text{mean}(diffs)\|$)ë¥¼ ìŠ¤ìº”.
2. ê¸°ëŠ¥:
   - ìŠ¤ìº” ë²”ìœ„(Layer 8~28) ì„¤ì • ë° ì‹¤í–‰.
   - Refusal Intensity Chart: ë ˆì´ì–´ë³„ ì ìˆ˜ë¥¼ ì„ í˜• ê·¸ëž˜í”„ë¡œ ì‹œê°í™”.
   - Vector Extraction: ê°€ìž¥ ì ìˆ˜ê°€ ë†’ì€ ìƒìœ„ $N$ê°œ ë ˆì´ì–´ì˜ PCA ì„±ë¶„($k$)ì„ ì¶”ì¶œí•˜ì—¬ ì„¸ì…˜ì— ì €ìž¥.

### íƒ­ B: ì‹¤ì‹œê°„ ìˆ˜ìˆ  ì±„íŒ… (Live Steering)
1. ë™ìž‘: ì‚¬ìš©ìžê°€ ìŠ¬ë¼ì´ë”ë¡œ íŒŒë¼ë¯¸í„°ë¥¼ ì¡°ì ˆí•˜ë©° ì¦‰ì„ì—ì„œ íƒˆì˜¥ ì„±ëŠ¥ í™•ì¸.
2. ê¸°ëŠ¥:
   - Parameter Control: $k$(ì°¨ì›), $\alpha$(ê°•ë„/coeff) ì¡°ì ˆ ìŠ¬ë¼ì´ë”.
   - Real-time Hooking: ì§ˆë¬¸ ìž…ë ¥ ì‹œ ì„¤ì •ëœ íŒŒë¼ë¯¸í„°ë¡œ make_robust_projection_hook ì ìš©.
   - Chat History: ì´ íƒ­ì—ì„œì˜ ì±„íŒ…ì€ ì‹¤í—˜ ê²°ê³¼ ë°ì´í„°ì™€ ë³„ê°œë¡œ ì¼íšŒì„±ìœ¼ë¡œ ê´€ë¦¬ë¨.

### íƒ­ C: ì „ìˆ˜ ì¡°ì‚¬ ë° ë¦¬í¬íŠ¸ (Bulk Research)
1. ë™ìž‘: ëŒ€ëŸ‰ì˜ ì§ˆë¬¸ì§€ë¥¼ íŠ¹ì • ì„¸íŒ…ê°’ìœ¼ë¡œ ì¼ê´„ ì²˜ë¦¬í•˜ê³  ì—°êµ¬ ë°ì´í„°ë¥¼ ê¸°ë¡.
2. ë°ì´í„° ë§¤ì¹­ ë¡œì§ (Critical):
   - Input: .csv ë˜ëŠ” .txt ì§ˆë¬¸ì§€ ì—…ë¡œë“œ (ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸í™”).
   - Snapshot: 'ì‹¤í—˜ ì‹œìž‘' ë²„íŠ¼ í´ë¦­ ì‹œì ì˜ íŒŒë¼ë¯¸í„°($k, \alpha, Layers$)ë¥¼ ê³ ì •.
   - Mapping: ê³ ì •ëœ íŒŒë¼ë¯¸í„° ì •ë³´ë¥¼ ê° í–‰(Row)ì— ë¬¸ìžì—´ë¡œ ë°•ì•„ ë„£ì–´ ë‹µë³€ê³¼ ë§¤ì¹­.
3. ì—°êµ¬ í…Œì´ë¸” (st.data_editor):
   - êµ¬ì¡°: ID | ì„¤ì •(k/a/L) | ì§ˆë¬¸(Prompt) | ì‘ë‹µ(Response) | íƒˆì˜¥ì„±ê³µë¥ (ìž…ë ¥) | ë¬´ê²°ì„±(ìž…ë ¥) | ë¹„ê³ .
   - ì €ìž¥: í…Œì´ë¸” ìˆ˜ì • ì‹œ ë¡œì»¬ experiment_results.csvì— ì¦‰ì‹œ ë°˜ì˜(Append/Sync).

## 3. ê¸°ìˆ ì  ê°•ì œ ì‚¬í•­ (Implementation Rules)
### A. ìˆ˜ì¹˜ ì •ë°€ë„ ë° ìˆ˜ìˆ  ê³µì‹AntigravityëŠ” ë°˜ë“œì‹œ ë‹¤ìŒ ìˆ˜ì‹ì„ float32 ì •ë°€ë„ë¡œ Hook ë‚´ì— êµ¬í˜„í•´ì•¼ í•œë‹¤.

$$h' = h - \alpha \cdot \text{Proj}_{V}(h)$$

ì—¬ê¸°ì„œ $\text{Proj}_{V}(h)$ëŠ” PCAë¡œ ì¶”ì¶œëœ $k$ì°¨ì› ì„œë¸ŒìŠ¤íŽ˜ì´ìŠ¤ì— ëŒ€í•œ íˆ¬ì˜ì´ë‹¤.

### B. GPU ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ëª¨ë“  íŽ˜ì´ì§€ í•˜ë‹¨ í˜¹ì€ ì‚¬ì´ë“œë°”ì— ì‹¤ì‹œê°„ GPU ìƒíƒœë¥¼ í‘œì‹œí•œë‹¤.
- ëª…ë ¹ì–´: nvidia-smi --query-gpu=memory.used,memory.total --format=csv,nounits,noheader
- ëª©ì : OCI A1(24GB)ì˜ OOM ë°©ì§€ ë° ì—°ì‚° ê°€ì‹œì„± í™•ë³´.

### C. ì„¸ì…˜ ìƒíƒœ(Session State) ê´€ë¦¬
- ëª¨ë¸ ê°ì²´: íŽ˜ì´ì§€ ì´ë™ ì‹œ ìž¬ë¡œë“œ ë°©ì§€ (st.cache_resource).
- ë°ì´í„° ë…ë¦½ì„±: [ì¼ë°˜ ì±„íŒ…], [ì‹¤ì‹œê°„ ìˆ˜ìˆ  ì±„íŒ…], [ì „ìˆ˜ ì¡°ì‚¬]ì˜ ë°ì´í„°ëŠ” ì„œë¡œ ë‹¤ë¥¸ Keyë¡œ ê´€ë¦¬í•˜ì—¬ í˜¼ì„  ë°©ì§€.
- Persistence: ì‚¬ìš©ìžê°€ í…Œì´ë¸”ì— ìˆ˜ë™ ìž…ë ¥í•œ ì ìˆ˜ëŠ” ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ ì‹œì—ë„ ìœ ì‹¤ë˜ì§€ ì•Šë„ë¡ íŒŒì¼ ì‹œìŠ¤í…œê³¼ ë™ê¸°í™”.

## 4. [ìµœì¢… ì§„í™”í˜•] ë°±ì—”ë“œ ì—”ì§„ ìŠ¤í¬ë¦½íŠ¸ (Antigravity ì°¸ì¡°ìš©)
```Python
import torch
from transformer_lens import HookedTransformer
from sklearn.decomposition import PCA
import numpy as np

# [Antigravity: ì´ í•µì‹¬ ë¡œì§ì„ UIì™€ ì—°ê²°í•˜ì—¬ íŽ˜ì´ì§€ë³„ ê¸°ëŠ¥ì„ ì™„ì„±í•  ê²ƒ]
def get_refusal_subspace(model, harmful_prompts, harmless_prompts, layer_idx, k=3):
    diffs = []
    for p_bad, p_good in zip(harmful_prompts, harmless_prompts):
        with torch.no_grad():
            _, cache_bad = model.run_with_cache(p_bad, names_filter=lambda n: n.endswith(f"blocks.{layer_idx}.hook_resid_pre"))
            _, cache_good = model.run_with_cache(p_good, names_filter=lambda n: n.endswith(f"blocks.{layer_idx}.hook_resid_pre"))
            # ìˆ˜ì¹˜ ì •ë°€ë„ë¥¼ ìœ„í•´ float32 ì‚¬ìš©
            d = cache_bad[f"blocks.{layer_idx}.hook_resid_pre"][0, -1, :].float() - cache_good[f"blocks.{layer_idx}.hook_resid_pre"][0, -1, :].float()
            diffs.append(d.cpu().numpy())
    
    pca = PCA(n_components=k)
    pca.fit(np.stack(diffs))
    return torch.tensor(pca.components_, dtype=torch.float32, device="cuda")

def make_robust_projection_hook(vectors, coeff=1.0):
    def hook_fn(resid_pre, hook):
        h_fp32 = resid_pre.float()
        dot_products = torch.einsum("bsd,kd->bsk", h_fp32, vectors)
        h_parallel = torch.einsum("bsk,kd->bsd", dot_products, vectors)
        return (h_fp32 - coeff * h_parallel).to(resid_pre.dtype)
    return hook_fn
```
