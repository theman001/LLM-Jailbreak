# 📄 [문서 5] Antigravity를 위한 알고리즘 및 예외 처리 지침(최적화)
이 문서는 Antigravity가 코드를 짤 때 절대 타협해서는 안 되는 '**Technical Guardrails**'다.

## 1. 수학적 연산 정밀도 최적화 (Precision Logic)
Antigravity는 Hook 내부 로직 구현 시 반드시 다음 순서를 엄수해야 한다.
- Bad: `resid_pre - coeff * projection` (FP16 상태에서 바로 계산)
- Good (Strict):
  1. `resid_pre.float()` (FP32 업캐스팅)
  2. `projection 계산` (PCA 성분 $V$ 활용)
  3. `(h_fp32 - coeff * projection).to(dtype=float16)` (연산 후 복구)
- 이유: FP16에서 투영 연산을 반복하면 수치적 오차가 누적되어 모델의 전체 지능이 무너짐.

## 2. VRAM 세이프 가드 (Memory Safety)
OCI A1(24GB) 인스턴스의 안정성을 위해 다음 예외 처리를 강제한다.
- Bulk Research 실행 시: 매 5번째 질문 생성 완료 후 `gc.collect()`와 `torch.cuda.empty_cache()` 강제 호출.
- Cache Management: `run_with_cache` 호출 시 `names_filter`를 사용하여 필요한 레이어의 `hook_resid_pre`만 캡처하고, 사용 직후 해당 캐시 오브젝트를 `del`로 명시적 삭제.

## 3. 데이터 무결성 보호 (Atomic Save)
연구 리포트 기록 시 데이터 유실 방지를 위한 지침.
- State Sync: `t.data_edito`r의 `on_change` 콜백을 활용하여 사용자가 점수를 수정하는 즉시 CSV 파일에 쓰기 작업을 수행할 것.
- Hash ID: 각 실험 레코드는 `[Timestamp] + [k] + [coeff] + [layer_list]`를 조합한 고유 해시값을 ID로 가져야 함.

## 4. UI/UX 반응성 최적화
- Model Loading: 모델 로딩 중에는 `st.spinner`와 함께 현재 로드 중인 레이어 번호를 실시간으로 표시할 것.
- Async Monitor: GPU 모니터링 위젯은 메인 추론 루프와 별도의 쓰레드 또는 주기적 리프레시를 통해 끊김 없이 표시될 것.
