# 📄 [문서 5] Antigravity를 위한 알고리즘 및 예외 처리 지침(최적화)
이 문서는 Antigravity가 코드를 짤 때 절대 타협해서는 안 되는 '**Technical Guardrails**'다.

## 1. 수학적 연산 정밀도 최적화 (Precision Logic)
Antigravity는 Hook 내부 로직 구현 시 반드시 다음 순서를 엄수해야 한다.
- Bad: `resid_pre - coeff * projection` (FP16 상태에서 바로 계산)
- Good (Strict):
  1. `resid_pre.float()` (FP32 업캐스팅)
  2. `projection 계산` (PCA 성분 $V$ 활용)
  3. `(h_fp32 - coeff * projection).to(dtype=float16)` (연산 후 복구)
- 이유: FP16에서 투영 연산을 반복하면 수치적 오차가 누적되어 모델의 전체 지능이 무너짐.

## 2. VRAM 세이프 가드 (Memory Safety)
OCI A1(24GB) 인스턴스의 안정성을 위해 다음 예외 처리를 강제한다.
- Bulk Research 실행 시: 매 5번째 질문 생성 완료 후 `gc.collect()`와 `torch.cuda.empty_cache()` 강제 호출.
- Cache Management: `run_with_cache` 호출 시 `names_filter`를 사용하여 필요한 레이어의 `hook_resid_pre`만 캡처하고, 사용 직후 해당 캐시 오브젝트를 `del`로 명시적 삭제.

## 3. 데이터 무결성 보호 (Atomic Save)
연구 리포트 기록 시 데이터 유실 방지를 위한 지침.
- State Sync: `t.data_edito`r의 `on_change` 콜백을 활용하여 사용자가 점수를 수정하는 즉시 CSV 파일에 쓰기 작업을 수행할 것.
- Hash ID: 각 실험 레코드는 `[Timestamp] + [k] + [coeff] + [layer_list]`를 조합한 고유 해시값을 ID로 가져야 함.

## 4. UI/UX 반응성 최적화
- Model Loading: 모델 로딩 중에는 `st.spinner`와 함께 현재 로드 중인 레이어 번호를 실시간으로 표시할 것.
- Async Monitor: GPU 모니터링 위젯은 메인 추론 루프와 별도의 쓰레드 또는 주기적 리프레시를 통해 끊김 없이 표시될 것.

## 5. 실험 데이터셋 규격 및 업로드 지침 (Dataset Spec)
서브탭 C(전수 조사)에서 사용자가 업로드하는 파일은 다음 규격을 엄격히 준수해야 한다.
- 파일 형식: `.csv` (UTF-8 인코딩) 또는 `.txt`.
- 데이터 구조:
   - CSV: 반드시 `prompt`라는 이름의 컬럼이 존재해야 함.
   - TXT: 한 행(Line)을 하나의 독립된 질문으로 간주함.
- 대조군 구성 가이드: 거절 벡터 추출의 정확도를 높이기 위해, 유해 질문과 주제는 유사하되 의도가 안전한 질문(예: '해킹 방법' vs '네트워크 보안 기초')을 페어로 구성할 것을 권장함.

## 6. 실전 트러블슈팅 및 성능 튜닝 (Troubleshooting)
OCI A1(24GB) 환경에서 운영 중 발생할 수 있는 이상 현상에 대한 자동/수동 대응 지침이다.
- VRAM 부족(OOM) 대응:
  - 실행 중 OOM 발생 시 현재 진행 중인 세션을 중단하고 `torch.cuda.empty_cache()`를 즉시 실행할 것.
  - 해결되지 않을 경우 `target_layers`의 개수를 줄이거나 `k` 값을 하향 조정하도록 사용자에게 알림.
- 답변 품질 저하(횡설수설)
  - 대응:`coeff` 값이 1.2를 초과할 경우 모델의 기본 지능이 손상될 확률이 높음.
  - 탈옥은 성공했으나 문맥이 무너질 경우 `coeff`를 0.1 단위로 낮추며 최적 지점을 찾도록 가이드함.

## 7. 연구 결과 시각화 명세 (Visualization Spec)
연구 리포트의 가독성을 높이기 위해 다음 시각화 요소를 화면에 배치한다.
- 상관관계 차트: `st.scatter_chart`를 사용하여 $k$ 차원 수와 탈옥 성공률 간의 분포를 표시.
- 거절 강도 히트맵: 스캔 페이지(탭 A)에서 측정된 레이어별 `efusal Intensity Score`를 히트맵으로 시각화하여 급소를 직관적으로 표현.
- 비교 요약 위젯: `st.metric`을 사용하여 이전 실험 대비 탈옥 성공률의 증감 폭을 표시.

---
# ⚠️ Antigravity 최종 지시사항
"이 추가 지침은 시스템의 '**실전성**'을 보장하기 위한 것이다. 특히 사용자가 외부 파일을 업로드했을 때 발생할 수 있는 데이터 파싱 에러와 VRAM 고갈 문제를 최우선으로 방어하는 로직을 구현해라."
